services:
  backend:
    build: ./packages/backend
    container_name: bun-backend
    restart: always
    ports:
      - "8080:3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=http://libsql-server:8080
    depends_on:
      - libsql-server

  libsql-server:
    image: ghcr.io/tursodatabase/libsql-server:latest
    container_name: libsql-server
    restart: always
    ports:
      - "127.0.0.1:8081:8080" # We only need the HTTP port now
    volumes:
      - libsql-data:/var/lib/sqld
    environment:
      - SQLD_NODE=primary
    labels:
      - "my.libsql.service=true"

  libsql-backup:
    image: offen/docker-volume-backup:latest
    restart: always
    environment:
      - BACKUP_CRON_EXPRESSION=0 5 * * *
      - BACKUP_RETENTION_DAYS=7
      # --- FIX: USE SIMPLE NAME ---
      - BACKUP_FILENAME=latest-backup.tar.gz
      - STOP_CONTAINER_LABEL=my.libsql.service
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - libsql-data:/backup/source:ro
      - /home/first545455/infra/backups/tournament/libsql:/backup/archive
    labels:
      - "docker-volume-backup.stop-container=false"

volumes:
  libsql-data:
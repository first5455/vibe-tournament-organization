services:
  backend:
    build: ./packages/backend
    container_name: bun-backend
    restart: always
    ports:
      - "8080:3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=http://libsql-server:8080
    depends_on:
      - libsql-server

  libsql-server:
    image: ghcr.io/tursodatabase/libsql-server:latest
    container_name: libsql-server
    restart: always
    ports:
      - "127.0.0.1:8081:8080" # We only need the HTTP port now
    volumes:
      - libsql-data:/var/lib/sqld
    environment:
      - SQLD_NODE=primary
    labels:
      - "my.libsql.service=true"

  libsql-backup:
    image: alpine:latest
    restart: always
    # We mount the same volumes, but run a manual script
    volumes:
      - libsql-data:/backup/source:ro
      - /home/first545455/infra/backups/tournament/libsql:/backup/archive
    # THE MAGICAL COMMAND (Simple & Visible)
    # 1. Print message
    # 2. Create the zip file (Overwrite the old one)
    # 3. Print success
    # 4. Sleep for 1 day (86400 seconds)
    command: >
      sh -c "while true; do
      echo 'Starting backup...';
      tar -czf /backup/archive/libsql-backup.tar.gz -C /backup/source .;
      echo 'Backup created successfully.';
      sleep 86400;
      done"

volumes:
  libsql-data: